{% extends "base.html" %}

{% block app_content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="display-5">Admin Dashboard</h1>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Home
        </a>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Daily Schedule</h2>
        <div>
            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary">Manage Users</a>
        </div>
    </div>

    <div class="row">
        {% for day_name, details in schedule_data.items() %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">{{ day_name }}</h5>
                        <p class="mb-0 text-muted">{{ details.date.strftime('%B %d, %Y') }}</p>
                    </div>
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">
                            Total Attending: <span class="badge bg-primary rounded-pill">{{ details.total_attendees }}</span>
                        </h6>
                        <h6 class="card-subtitle mb-3 text-muted">
                            Meals: 
                            <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Veg: {{ details.veg_count }}</span>
                            <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Non-Veg: {{ details.non_veg_count }}</span>
                        </h6>

                        <div class="accordion" id="accordion-{{ day_name }}">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne-{{ day_name }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne-{{ day_name }}" aria-expanded="false" aria-controls="collapseOne-{{ day_name }}">
                                        <strong>Attending ({{ details.attendees|length }})</strong>
                                    </button>
                                </h2>
                                <div id="collapseOne-{{ day_name }}" class="accordion-collapse collapse" aria-labelledby="headingOne-{{ day_name }}" data-bs-parent="#accordion-{{ day_name }}">
                                    <div class="accordion-body p-0">
                                        <ul class="list-group list-group-flush">
                                            {% for entry in details.attendees %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div>
                                                        {{ entry.user.username }}
                                                        <span class="badge bg-info-subtle text-info-emphasis rounded-pill ms-2">{{ entry.meal_preference }}</span>
                                                        {% if entry.reassignment_request %}
                                                            <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill ms-1" 
                                                                  data-bs-toggle="tooltip" 
                                                                  data-bs-placement="top" 
                                                                  title="Reason: {{ entry.reassignment_reason }}">
                                                                <i class="bi bi-exclamation-triangle-fill"></i> Request Pending
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <a href="{{ url_for('admin.swap_user', schedule_id=entry.id) }}" class="btn btn-outline-warning btn-sm">
                                                        <i class="bi bi-arrow-repeat"></i> Swap
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="list-group-item">None</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo-{{ day_name }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo-{{ day_name }}" aria-expanded="false" aria-controls="collapseTwo-{{ day_name }}">
                                        <strong>Not Attending ({{ details.absentees|length }})</strong>
                                    </button>
                                </h2>
                                <div id="collapseTwo-{{ day_name }}" class="accordion-collapse collapse" aria-labelledby="headingTwo-{{ day_name }}" data-bs-parent="#accordion-{{ day_name }}">
                                    <div class="accordion-body p-0">
                                        <ul class="list-group list-group-flush">
                                            {% for entry in details.absentees %}
                                                <li class="list-group-item">{{ entry.user.username }}</li>
                                            {% else %}
                                                <li class="list-group-item">None</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="card-subtitle mb-2 text-muted">Attendees ({{ details.total_attendees }}/{{ OFFICE_CAPACITY }})</h6>
                        <ul class="list-group list-group-flush">
                            {% for entry in details.attendees %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        {{ entry.user.username }} 
                                        <small class="text-muted">({{ entry.meal_preference }})</small>
                                        {% if entry.was_auto_assigned %}<span class="badge bg-warning text-dark">Auto</span>{% endif %}
                                    </span>
                                    <div>
                                        {% if entry.reassignment_request %}
                                            <span class="badge bg-info">Swap Requested</span>
                                        {% endif %}
                                        <a href="{{ url_for('admin.swap_user', schedule_id=entry.id) }}" class="btn btn-outline-secondary btn-sm">Swap</a>
                                    </div>
                                </li>
                            {% else %}
                                <li class="list-group-item">No one is scheduled to come in yet.</li>
                            {% endfor %}
                        </ul>

                        {% if details.available_for_swap %}
                        <h6 class="card-subtitle mb-2 mt-3 text-muted">Available for Swap</h6>
                        <ul class="list-group list-group-flush">
                            {% for entry in details.available_for_swap %}
                                <li class="list-group-item">{{ entry.user.username }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    {% if whatsapp_messages.get(day_name) or details.total_attendees < OFFICE_CAPACITY %}
                    <div class="card-footer bg-light">
                        {% if whatsapp_messages.get(day_name) %}
                            <h6 class="mb-2">WhatsApp Message</h6>
                            <div class="position-relative">
                               <textarea class="form-control" id="whatsapp-msg-{{ day_name }}" rows="6" readonly>{{ whatsapp_messages[day_name] }}</textarea>
                               <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-2" 
                                       onclick="copyToClipboard('whatsapp-msg-{{ day_name }}', this)"
                                       data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to clipboard">
                                    <i class="bi bi-clipboard"></i>
                               </button>
                            </div>
                        {% endif %}

                        {% if details.total_attendees < OFFICE_CAPACITY %}
                            <div class="mt-3">
                                <form action="{{ url_for('admin.auto_assign', date_iso=details.date.isoformat()) }}" method="POST" onsubmit="return confirm('This will automatically assign interns and fill remaining slots for {{ day_name }}. This action cannot be undone. Are you sure?');">
                                    <button type="submit" class="btn btn-info w-100">
                                        <i class="bi bi-magic"></i> Auto-Assign & Fill Slots
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <p>No schedule data available for this week yet.</p>
        {% endfor %}
    </div>

    <div class="container-fluid mt-3">
        <form action="{{ url_for('admin.clear_schedule') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete all schedule entries? This action cannot be undone.');">
            <button type="submit" class="btn btn-danger">Clear All Schedule Records</button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function copyToClipboard(elementId, button) {
    const textarea = document.getElementById(elementId);
    textarea.select();
    navigator.clipboard.writeText(textarea.value).then(() => {
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check-lg"></i>';
        
        const tooltip = new bootstrap.Tooltip(button, {
            title: 'Copied!',
            trigger: 'manual'
        });
        tooltip.show();
        
        setTimeout(() => {
            tooltip.hide();
            button.innerHTML = originalIcon;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})
</script>
{% endblock %} 